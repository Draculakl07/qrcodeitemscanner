<!DOCTYPE html>
<html lang="en">
<head>

   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <meta charset="UTF-8" />
  <title>QR Stock Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h1>📷 QR Scanner - Take Item</h1>
  <div id="reader" style="width: 300px;"></div>
  <p id="resultMsg"></p>

  <script>
    const html5QrCode = new Html5Qrcode("reader");

    function onScanSuccess(qrCodeMessage) {
  html5QrCode.stop();  // Stop scanner temporarily

  // Step 1: fetch item info first to get unit
  fetch("http://localhost:5000/api/stock")
    .then(res => res.json())
    .then(stockItems => {
      const item = stockItems.find(i => i.qrCode === qrCodeMessage);
      if (!item) {
        alert("❌ Item not found in stock.");
        restartScanner();
        return;
      }

      const qty = prompt(`How many ${item.unit || "units"} are you taking?`);
      if (!qty || isNaN(qty)) {
        alert("❌ Invalid quantity.");
        restartScanner();
        return;
      }

      // Step 2: reduce quantity
      fetch("http://localhost:5000/api/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          qrCode: qrCodeMessage,
          quantity: parseInt(qty)
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.message) {
            document.getElementById("resultMsg").innerText =
              `✅ ${data.message} | Remaining: ${data.item.quantity} ${data.item.unit}`;
          } else {
            document.getElementById("resultMsg").innerText = "⚠️ " + data;
          }
          restartScanner();
        })
        .catch(err => {
          console.error(err);
          document.getElementById("resultMsg").innerText = "❌ Server error.";
          restartScanner();
        });
    });
}


    function onScanFailure(error) {
      // Optional: log failed attempts
    }

    function restartScanner() {
      setTimeout(() => {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        );
      }, 3000);  // restart after 3 seconds
    }

    // Start on load
    restartScanner();
  </script>
</body>
</html>
